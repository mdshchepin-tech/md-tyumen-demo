<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0"
  />
  <title>КГ «Мать и Дитя» Тюмень — Викторина</title>
  <meta
    name="description"
    content="Интерактивная медицинская викторина и клинический случай. Организатор: Клинический госпиталь «Мать и Дитя» Тюмень."
  />
  <style>
    :root {
      --primary: #00a0e3;
      --secondary: #8dc63f;
      --accent: #d4145a;
      --light: #f4f9fc;
      --dark: #333333;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: Arial, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, sans-serif;
    }

    body {
      background-color: var(--light);
      color: var(--dark);
      line-height: 1.6;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      background: linear-gradient(135deg, var(--primary), #0077b6);
      color: #fff;
      padding: 20px 0;
      text-align: center;
      border-radius: 0 0 20px 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .logo {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 15px;
      gap: 15px;
    }

    .logo-circle {
      width: 80px;
      height: 80px;
      background-color: #fff;
      border-radius: 50%;
      display: grid;
      place-items: center;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      flex: 0 0 auto;
    }

    .logo-text {
      font-size: 24px;
      font-weight: 700;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2);
    }

    h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }

    .subtitle {
      font-size: 18px;
      opacity: 0.9;
    }

    .main-menu {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin: 40px 0;
      flex-wrap: wrap;
    }

    .menu-card {
      background: #fff;
      border-radius: 15px;
      overflow: hidden;
      width: 280px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s, box-shadow 0.3s;
      cursor: pointer;
    }

    .menu-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 20px rgba(0, 0, 0, 0.15);
    }

    .menu-image {
      height: 160px;
      overflow: hidden;
    }

    .menu-image > div {
      height: 100%;
      display: grid;
      place-items: center;
      color: #fff;
      font-size: 48px;
      user-select: none;
    }

    .menu-content {
      padding: 20px;
      text-align: center;
    }

    .menu-content h2 {
      color: var(--primary);
      margin-bottom: 10px;
      font-size: 20px;
    }

    .menu-content p {
      color: var(--dark);
      font-size: 14px;
      margin-bottom: 15px;
    }

    .btn {
      display: inline-block;
      background-color: var(--primary);
      color: #fff;
      padding: 10px 20px;
      border-radius: 30px;
      text-decoration: none;
      font-weight: 700;
      transition: background-color 0.3s, opacity 0.2s;
      border: none;
      cursor: pointer;
    }

    .btn:hover { background-color: #0080c0; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .btn-secondary { background-color: var(--secondary); }
    .btn-secondary:hover { background-color: #7cb52c; }

    .registration-form,
    .quiz-container,
    .case-study {
      background: #fff;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
      margin: 30px 0;
    }

    .form-title {
      text-align: center;
      color: var(--primary);
      margin-bottom: 25px;
      font-size: 24px;
      font-weight: 800;
    }

    .form-group { margin-bottom: 20px; }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 700;
      color: var(--dark);
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      margin-top: 10px;
      gap: 8px;
    }

    .required { color: var(--accent); }

    .quiz-tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 2px solid #eee;
      gap: 10px;
      flex-wrap: wrap;
    }

    .quiz-tab {
      padding: 10px 20px;
      cursor: pointer;
      font-weight: 700;
      color: var(--dark);
      transition: all 0.2s ease;
      border-radius: 8px 8px 0 0;
    }

    .quiz-tab.active {
      color: var(--primary);
      border-bottom: 3px solid var(--primary);
      background: #f6fbff;
    }

    .question {
      margin-bottom: 25px;
      padding-bottom: 20px;
      border-bottom: 1px solid #eee;
    }

    .question h3 {
      color: var(--primary);
      margin-bottom: 15px;
      font-size: 20px;
    }

    .options { display: grid; gap: 12px; }

    .option { display: flex; align-items: center; gap: 10px; }

    .case-header,
    .case-stage {
      margin-bottom: 25px;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 10px;
      border-left: 5px solid var(--primary);
    }

    .case-header h2,
    .case-stage h3 { color: var(--primary); margin-bottom: 10px; }

    .hidden { display: none !important; }

    .score-display {
      text-align: center;
      font-size: 20px;
      font-weight: 800;
      color: var(--primary);
      margin: 20px 0;
      padding: 15px;
      background-color: #f0f8ff;
      border-radius: 10px;
      border: 2px dashed var(--primary);
    }

    .victory-modal {
      position: fixed;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .victory-modal.show { display: flex; }

    .modal-content {
      background: #fff;
      padding: 40px;
      border-radius: 15px;
      text-align: center;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      animation: popIn 0.4s ease;
    }

    @keyframes popIn {
      0% { transform: scale(0.92); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }

    .modal-content h2 {
      color: var(--accent);
      margin-bottom: 20px;
      font-size: 28px;
    }

    footer {
      text-align: center;
      padding: 20px;
      margin-top: 40px;
      color: var(--dark);
      font-size: 14px;
      border-top: 1px solid #ddd;
    }

    .participant-badge {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      background: #ffffffcc;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 13px;
      border: 1px solid #e8eef5;
    }

    @media (max-width: 768px) {
      .main-menu { flex-direction: column; align-items: center; }
      .menu-card { width: 100%; max-width: 350px; }
      .quiz-tabs { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="logo" aria-label="Логотип Мать и Дитя Тюмень">
        <div class="logo-circle" aria-hidden="true">
          <svg width="40" height="40" viewBox="0 0 24 24" fill="#00a0e3" aria-hidden="true">
            <path d="M12 2c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2Zm9 7V7L15 5.5V7H9V5.5L3 7v2l7 2v2h4v-2l7-2Zm-7 7v3h-4v-3H8v7h8v-7h-2Z"/>
          </svg>
        </div>
        <div class="logo-text">Мать и Дитя<br /><span style="font-size: 18px">Тюмень</span></div>
      </div>
      <h1>Медицинская викторина</h1>
      <p class="subtitle">Проверьте свои знания и получите приз!</p>

      <div id="participant-badge" class="participant-badge hidden" aria-live="polite">
        <span id="badge-name"></span>
        <button id="switch-user" class="btn btn-secondary" style="padding:6px 10px;font-size:12px">Сменить участника</button>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- Главный экран (регистрация + меню) -->
    <section id="main-section">
      <div id="registration-block" class="registration-form">
        <h2 class="form-title">Регистрация участника</h2>

        <!-- ВНИМАНИЕ: замените action и entry.* на ваши значения Google Forms -->
        <form
          id="participant-form"
          action="https://docs.google.com/forms/d/e/1FAIpQLSf2cQ9qw90Jpacyw51eCZvHdFn4dEAEolEwjwflBtKZ7gvKBA/formResponse"
          method="POST"
          target="hidden_iframe"
          novalidate
        >
          <div class="form-group">
            <label for="fullname">Ф.И.О. <span class="required">*</span></label>
            <input type="text" id="fullname" name="entry.2005620554" required />
          </div>

          <div class="form-group">
            <label for="city">Город <span class="required">*</span></label>
            <input type="text" id="city" name="entry.1045781291" required />
          </div>

          <div class="form-group">
            <label for="workplace">Место работы <span class="required">*</span></label>
            <input type="text" id="workplace" name="entry.1065046570" required />
          </div>

          <div class="form-group">
            <label for="position">Должность <span class="required">*</span></label>
            <input type="text" id="position" name="entry.1166974658" required />
          </div>

          <div class="form-group">
            <label for="email">Электронная почта <span class="required">*</span></label>
            <input type="email" id="email" name="entry.1824927963" required />
          </div>

          <div class="form-group">
            <p>Хотели бы вы получить информацию об услугах КГ «Мать и дитя» Тюмень?</p>
            <div class="checkbox-group">
              <input type="checkbox" id="info-request" name="entry.1234567890" value="Да" />
              <label for="info-request">Да</label>
            </div>
          </div>

          <div class="form-group">
            <p>Интересно ли вам сотрудничать с КГ «Мать и дитя» Тюмень в качестве агента?</p>
            <div class="checkbox-group">
              <input type="checkbox" id="cooperation" name="entry.9876543210" value="Да" />
              <label for="cooperation">Да</label>
            </div>
          </div>

          <div class="form-group">
            <p class="required">* Для получения приза необходимо заполнить все обязательные поля.</p>
          </div>

          <button type="button" id="start-btn" class="btn">Отправить и начать</button>
        </form>
        <iframe name="hidden_iframe" id="hidden_iframe" style="display:none"></iframe>
      </div>

      <div class="main-menu">
        <div class="menu-card" id="quiz-card" data-target="quiz">
          <div class="menu-image">
            <div style="background:#00a0e3">?</div>
          </div>
          <div class="menu-content">
            <h2>Викторина</h2>
            <p>Проверьте свои медицинские знания в нашей викторине с вариантами ответов.</p>
            <button class="btn" data-action="open-section" data-target="quiz">Начать викторину</button>
          </div>
        </div>

        <div class="menu-card" id="case-card" data-target="case">
          <div class="menu-image">
            <div style="background:#8dc63f">+</div>
          </div>
          <div class="menu-content">
            <h2>Клинический случай</h2>
            <p>Разберите реальный клинический кейс и предложите оптимальную тактику.</p>
            <button class="btn btn-secondary" data-action="open-section" data-target="case">Разобрать случай</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Раздел: Викторина -->
    <section id="quiz-section" class="hidden" aria-labelledby="quiz-title">
      <div class="score-display">Текущий счёт: <span id="quiz-score">0</span> баллов</div>

      <div class="quiz-container">
        <h2 id="quiz-title" class="hidden">Викторина</h2>
        <div class="quiz-tabs" role="tablist" aria-label="Разделы викторины">
          <button class="quiz-tab active" role="tab" aria-selected="true" aria-controls="gynecology-quiz" id="tab-gyne" onclick="showQuizTab('gynecology', event)">Вспомогательные репродуктивные технологии и гинекология</button>
          <button class="quiz-tab" role="tab" aria-selected="false" aria-controls="obstetrics-quiz" id="tab-ob" onclick="showQuizTab('obstetrics', event)">Акушерство</button>
        </div>

        <div id="gynecology-quiz">
          <h2>Вспомогательные репродуктивные технологии и гинекология</h2>

          <div class="question">
            <h3>1. Сколько переносов эмбрионов было выполнено в ГК «Мать и Дитя» за последний отчётный год?</h3>
            <div class="options">
              <label class="option"><input type="radio" name="q1" value="0" /> до 5000</label>
              <label class="option"><input type="radio" name="q1" value="0" /> 5000–10000</label>
              <label class="option"><input type="radio" name="q1" value="0" /> 10000–20000</label>
              <label class="option"><input type="radio" name="q1" value="1" /> более 20000</label>
            </div>
          </div>

          <div class="question">
            <h3>2. В чем преимущество технологии «EmbryoScope» в культивировании эмбрионов?</h3>
            <div class="options">
              <label class="option"><input type="checkbox" name="q2" value="0.5" /> Стабильные условия культивирования</label>
              <label class="option"><input type="checkbox" name="q2" value="0.5" /> Непрерывный мониторинг и морфокинетический анализ</label>
              <label class="option"><input type="checkbox" name="q2" value="0" /> Позволяет «выбирать» пол или другие качества эмбриона</label>
              <label class="option"><input type="checkbox" name="q2" value="0" /> Позволяет обучать эмбрион этикету, письму и т. п.</label>
            </div>
          </div>

          <div class="question">
            <h3>3. Наиболее предпочтительный метод доступа в оперативной гинекологии?</h3>
            <div class="options">
              <label class="option"><input type="radio" name="q3" value="1" /> Эндоскопический</label>
              <label class="option"><input type="radio" name="q3" value="0" /> Лапаротомический</label>
              <label class="option"><input type="radio" name="q3" value="0" /> Влагалищный</label>
            </div>
          </div>

          <div class="question">
            <h3>4. Как называется современная малоинвазивная хирургическая техника для удаления эндометриоидных инфильтратов прямой кишки без разреза передней брюшной стенки?</h3>
            <div class="options">
              <label class="option"><input type="radio" name="q4" value="0" /> Лапароскопическая резекция</label>
              <label class="option"><input type="radio" name="q4" value="1" /> NOSE-резекция (Natural Orifice Specimen Extraction)</label>
              <label class="option"><input type="radio" name="q4" value="0" /> Открытая резекция</label>
            </div>
          </div>

          <div class="question">
            <h3>5. Какой метод хирургического лечения апикального пролапса демонстрирует наименьшую частоту рецидивов?</h3>
            <div class="options">
              <label class="option"><input type="radio" name="q5" value="0" /> Влагалищная гистерэктомия</label>
              <label class="option"><input type="radio" name="q5" value="1" /> Лапароскопическая промонтофиксация</label>
              <label class="option"><input type="radio" name="q5" value="0" /> Манчестерская операция</label>
              <label class="option"><input type="radio" name="q5" value="0" /> Кольпоперинеолеваторопластика</label>
            </div>
          </div>

          <button class="btn" onclick="calculateQuizScore('gynecology')">Завершить раздел</button>
        </div>

        <div id="obstetrics-quiz" class="hidden" tabindex="-1">
          <h2>Акушерство</h2>

          <div class="question">
            <h3>1. Сколько детей родилось в стенах группы компаний «Мать и дитя» за всё время?</h3>
            <div class="options">
              <label class="option"><input type="radio" name="q6" value="0" /> 10000</label>
              <label class="option"><input type="radio" name="q6" value="0" /> 30000</label>
              <label class="option"><input type="radio" name="q6" value="0" /> 50000</label>
              <label class="option"><input type="radio" name="q6" value="1" /> более 100000</label>
            </div>
          </div>

          <div class="question">
            <h3>2. Какие эндоваскулярные технологии применяются в менеджменте акушерских кровотечений?</h3>
            <div class="options">
              <label class="option"><input type="checkbox" name="q7" value="0" /> Баллонная ангиопластика, стентирование маточных артерий</label>
              <label class="option"><input type="checkbox" name="q7" value="0.5" /> Временная баллонная окклюзия подвздошных артерий</label>
              <label class="option"><input type="checkbox" name="q7" value="0.5" /> Эмболизация маточных артерий</label>
              <label class="option"><input type="checkbox" name="q7" value="0" /> Радиочастотная и лазерная абляция маточных артерий</label>
            </div>
          </div>

          <div class="question">
            <h3>3. Какие системы телемедицинского контроля за состоянием беременной используются в «Мать и дитя»?</h3>
            <div class="options">
              <label class="option"><input type="checkbox" name="q8" value="0.34" /> Домашний фетальный монитор (КТГ на дому)</label>
              <label class="option"><input type="checkbox" name="q8" value="0.33" /> Система непрерывного мониторинга уровня глюкозы</label>
              <label class="option"><input type="checkbox" name="q8" value="0.33" /> Домашний анализ мочи (Мобурин А-1)</label>
              <label class="option"><input type="checkbox" name="q8" value="0" /> Телемедицинский аборт</label>
              <label class="option"><input type="checkbox" name="q8" value="0" /> Роды по FaceTime</label>
            </div>
          </div>

          <div class="question">
            <h3>4. «Пионером» каких внутриутробных вмешательств в России является ГК «Мать и дитя»?</h3>
            <div class="options">
              <label class="option"><input type="checkbox" name="q9" value="0.5" /> Внутриутробная коррекция spina bifida</label>
              <label class="option"><input type="checkbox" name="q9" value="0.5" /> Баллонная вальвулопластика при аортальном стенозе</label>
              <label class="option"><input type="checkbox" name="q9" value="0" /> Баллонная атриосептостомия</label>
              <label class="option"><input type="checkbox" name="q9" value="0" /> Резекция крестцово-копчиковой тератомы</label>
            </div>
          </div>

          <div class="question">
            <h3>5. Клинический госпиталь «Мать и дитя» Тюмень — это?</h3>
            <div class="options">
              <label class="option"><input type="checkbox" name="q10" value="0" /> Акушерский стационар 2 уровня «для богатых»</label>
              <label class="option"><input type="checkbox" name="q10" value="0.5" /> Акушерский стационар 3 уровня в составе многопрофильного госпиталя</label>
              <label class="option"><input type="checkbox" name="q10" value="0.5" /> Безопасность, комфорт и удобство для пациентов</label>
            </div>
          </div>

          <button class="btn" onclick="calculateQuizScore('obstetrics')">Завершить раздел</button>
        </div>
      </div>

      <button class="btn" data-action="open-section" data-target="main">Вернуться на главную</button>
    </section>

    <!-- Раздел: Клинический случай (Консилиум) -->
    <section id="case-section" class="hidden" aria-labelledby="case-title">
      <div class="score-display">Текущий счёт: <span id="case-score">0</span> баллов</div>

      <div class="case-study">
        <div class="case-header">
          <h2 id="case-title">Клинический случай</h2>
          <p>Пациентка А, 35 лет. Планирует вторую беременность.</p>
          <p>
            Анамнез: беременность после ЭКО по причине бесплодия неясного генеза; ИЦН, выполнен серкляж;
            на 33 неделе — спонтанные преждевременные роды, ПОНРП в I периоде родов; экстренное кесарево сечение.
          </p>
        </div>

        <div class="case-stage">
          <h3>Этап 1. Прегравидарная подготовка</h3>
          <p><strong>Какое гинекологическое вмешательство рекомендовано на прегравидарном этапе?</strong></p>
          <div class="options">
            <label class="option"><input type="radio" name="stage1" value="0" /> Диагностическая гистероскопия</label>
            <label class="option"><input type="radio" name="stage1" value="0" /> Диагностическая лапароскопия</label>
            <label class="option"><input type="radio" name="stage1" value="1" /> Лапароскопический серкляж</label>
            <label class="option"><input type="radio" name="stage1" value="0" /> Вмешательств не требуется</label>
          </div>
        </div>

        <div class="case-stage">
          <h3>Этап 2. Диагностика осложнений беременности</h3>
          <p>Беременность после ЭКО. По УЗ-скринингу — предлежание плаценты, признаки врастания в рубец на матке.</p>
          <p><strong>Какой дополняющий метод диагностики выбрать?</strong></p>
          <div class="options">
            <label class="option"><input type="radio" name="stage2" value="1" /> МРТ</label>
            <label class="option"><input type="radio" name="stage2" value="0" /> КТГ</label>
            <label class="option"><input type="radio" name="stage2" value="0" /> КТ</label>
            <label class="option"><input type="radio" name="stage2" value="0" /> Лапароскопия</label>
          </div>
        </div>

        <div class="case-stage">
          <h3>Этап 3. Осложнение в III триместре</h3>
          <p>
            В 30 недель — эпизод тянущих болей и скудных кровянистых выделений. Госпитализация в стационар III уровня,
            токолиз, профилактика РДС плода. Жалоб и кровотечения нет, показаний к экстренному КС нет.
          </p>
          <p><strong>Оптимальный срок родоразрешения:</strong></p>
          <div class="options">
            <label class="option"><input type="radio" name="stage3" value="0" /> Сразу после профилактики РДС</label>
            <label class="option"><input type="radio" name="stage3" value="1" /> 34–36 недель</label>
            <label class="option"><input type="radio" name="stage3" value="0" /> 36+ недель</label>
            <label class="option"><input type="radio" name="stage3" value="0" /> В доношенном сроке</label>
          </div>
        </div>

        <div class="case-stage">
          <h3>Этап 4. Хирургическая тактика</h3>
          <p>Пациентка планирует сохранение фертильности. <strong>Какую тактику выбрать?</strong></p>
          <div class="options">
            <label class="option"><input type="radio" name="stage4" value="1" /> Органосохраняющая операция</label>
            <label class="option"><input type="radio" name="stage4" value="0" /> Гистерэктомия</label>
            <label class="option"><input type="radio" name="stage4" value="0" /> Оставление плаценты in situ с отсроченной гистерэктомией</label>
          </div>
        </div>

        <div class="case-stage">
          <h3>Этап 5. Хирургический гемостаз</h3>
          <p><strong>Какие методы хирургического гемостаза предпочтительнее?</strong></p>
          <div class="options">
            <label class="option"><input type="checkbox" name="stage5" value="3" /> Эндоваскулярные методы (временная баллонная окклюзия подвздошных артерий/аорты)</label>
            <label class="option"><input type="checkbox" name="stage5" value="1" /> Деваскуляризация матки (перевязка/временная окклюзия)</label>
            <label class="option"><input type="checkbox" name="stage5" value="1" /> Компрессионный гемостаз (швы, баллонная тампонада и др.)</label>
          </div>
        </div>

        <button class="btn" onclick="calculateCaseScore()">Завершить клинический случай</button>
      </div>

      <button class="btn" data-action="open-section" data-target="main">Вернуться на главную</button>
    </section>
  </div>

  <div id="victory-modal" class="victory-modal" role="dialog" aria-modal="true" aria-labelledby="victory-title">
    <div class="modal-content">
      <h2 id="victory-title">Поздравляем!</h2>
      <p>Вы набрали 5 и более баллов и победили в викторине!</p>
      <p>Заберите ваш приз!</p>
      <button class="btn" onclick="hideVictoryModal()">Отлично!</button>
    </div>
  </div>

  <footer>
    <div class="container">
      <p>Клинический госпиталь «Мать и Дитя» Тюмень © 2025</p>
      <p>Все права защищены</p>
    </div>
  </footer>

  <script>
    // ====== Состояние и очки ======
    let totalScore = 0;
    let gynecologyScore = 0;
    let obstetricsScore = 0;
    let caseScore = 0;

    const SECTIONS = {
      main: document.getElementById('main-section'),
      quiz: document.getElementById('quiz-section'),
      case: document.getElementById('case-section'),
    };

    const participantBadge = document.getElementById('participant-badge');
    const badgeName = document.getElementById('badge-name');
    const switchUserBtn = document.getElementById('switch-user');

    // ====== Утилиты интерфейса ======
    function showSection(id) {
      for (const key in SECTIONS) {
        SECTIONS[key].classList.add('hidden');
      }
      SECTIONS[id].classList.remove('hidden');
      updateScoreDisplay();
    }

    function showQuizTab(tabId, ev) {
      const gy = document.getElementById('gynecology-quiz');
      const ob = document.getElementById('obstetrics-quiz');
      gy.classList.add('hidden');
      ob.classList.add('hidden');

      document.querySelectorAll('.quiz-tab').forEach((t) => {
        t.classList.remove('active');
        t.setAttribute('aria-selected', 'false');
      });

      if (tabId === 'gynecology') {
        gy.classList.remove('hidden');
        document.getElementById('tab-gyne').classList.add('active');
        document.getElementById('tab-gyne').setAttribute('aria-selected', 'true');
        gy.focus?.();
      } else {
        ob.classList.remove('hidden');
        document.getElementById('tab-ob').classList.add('active');
        document.getElementById('tab-ob').setAttribute('aria-selected', 'true');
        ob.focus?.();
      }

      if (ev && ev.preventDefault) ev.preventDefault();
    }

    function updateScoreDisplay() {
      const s = totalScore.toFixed(1);
      const qs = document.getElementById('quiz-score');
      const cs = document.getElementById('case-score');
      if (qs) qs.textContent = s;
      if (cs) cs.textContent = s;
    }

    function checkVictory() {
      if (totalScore >= 5) {
        document.getElementById('victory-modal').classList.add('show');
      }
    }

    function hideVictoryModal() {
      document.getElementById('victory-modal').classList.remove('show');
    }

    // ====== Подсчёт очков ======
    function sumChecked(name, cap = 1) {
      const answers = document.querySelectorAll(`input[name="${name}"]:checked`);
      let s = 0;
      answers.forEach((a) => (s += parseFloat(a.value)));
      return Math.min(s, cap);
    }

    function valueOfChecked(name) {
      const ans = document.querySelector(`input[name="${name}"]:checked`);
      return ans ? parseFloat(ans.value) : 0;
    }

    function calculateQuizScore(section) {
      let score = 0;

      if (section === 'gynecology') {
        score += valueOfChecked('q1');
        score += sumChecked('q2', 1);
        score += valueOfChecked('q3');
        score += valueOfChecked('q4');
        score += valueOfChecked('q5');
        gynecologyScore = score;
      } else if (section === 'obstetrics') {
        score += valueOfChecked('q6');
        score += sumChecked('q7', 1);
        score += sumChecked('q8', 1);
        score += sumChecked('q9', 1);
        score += sumChecked('q10', 1);
        obstetricsScore = score;
      }

      totalScore = gynecologyScore + obstetricsScore + caseScore;
      updateScoreDisplay();
      checkVictory();
      alert(`Вы набрали ${score.toFixed(1)} балл(ов) в разделе! Общий счёт: ${totalScore.toFixed(1)}`);
    }

    function calculateCaseScore() {
      let score = 0;
      score += valueOfChecked('stage1');
      score += valueOfChecked('stage2');
      score += valueOfChecked('stage3');
      score += valueOfChecked('stage4');
      score += sumChecked('stage5', 5); // на всякий случай ограничим сверху

      caseScore = score;
      totalScore = gynecologyScore + obstetricsScore + caseScore;
      updateScoreDisplay();
      checkVictory();
      alert(`Вы набрали ${score.toFixed(1)} балл(ов) за клинический случай! Общий счёт: ${totalScore.toFixed(1)}`);
    }

    // ====== Регистрация (обязательная) и сохранение данных ======
    const REG_KEY = 'mdty_quiz_participant';

    function isRegistered() {
      try {
        return Boolean(localStorage.getItem(REG_KEY));
      } catch { return false; }
    }

    function saveParticipant(data) {
      try {
        localStorage.setItem(REG_KEY, JSON.stringify(data));
      } catch {}
    }

    function loadParticipant() {
      try {
        const raw = localStorage.getItem(REG_KEY);
        return raw ? JSON.parse(raw) : null;
      } catch { return null; }
    }

    function requireRegistrationBeforeOpen(targetSection) {
      if (!isRegistered()) {
        alert('Сначала пройдите регистрацию (все обязательные поля), затем начните игру.');
        document.getElementById('registration-block').scrollIntoView({ behavior: 'smooth' });
        return;
      }
      showSection(targetSection);
    }

    function updateBadge() {
      const data = loadParticipant();
      if (data && data.fullname) {
        badgeName.textContent = `Участник: ${data.fullname}`;
        participantBadge.classList.remove('hidden');
        document.getElementById('registration-block').classList.add('hidden');
      } else {
        participantBadge.classList.add('hidden');
        document.getElementById('registration-block').classList.remove('hidden');
      }
    }

    // Кнопки «Открыть раздел»
    document.querySelectorAll('[data-action="open-section"]').forEach((btn) => {
      btn.addEventListener('click', (e) => {
        const target = e.currentTarget.getAttribute('data-target');
        if (target === 'main') {
          showSection('main');
          return;
        }
        requireRegistrationBeforeOpen(target);
      });
    });

    // Отправка формы в Google Forms + локальное сохранение
    document.getElementById('start-btn').addEventListener('click', function () {
      const form = document.getElementById('participant-form');
      if (!form.checkValidity()) {
        alert('Пожалуйста, заполните все обязательные поля для регистрации.');
        return;
      }

      const data = {
        fullname: document.getElementById('fullname').value.trim(),
        city: document.getElementById('city').value.trim(),
        workplace: document.getElementById('workplace').value.trim(),
        position: document.getElementById('position').value.trim(),
        email: document.getElementById('email').value.trim(),
        info: document.getElementById('info-request').checked ? 'Да' : 'Нет',
        cooperation: document.getElementById('cooperation').checked ? 'Да' : 'Нет',
        submittedAt: new Date().toISOString(),
      };

      // Сохраняем локально (доступно для проверки организатором на устройстве)
      saveParticipant(data);
      updateBadge();

      // Отправляем в Google Forms через скрытый iframe
      form.submit();

      // После отправки разрешаем доступ к разделам
      alert('Спасибо! Регистрация отправлена. Можно начинать игру.');
      showSection('main');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    // Смена участника
    switchUserBtn.addEventListener('click', () => {
      if (confirm('Сбросить текущего участника и пройти регистрацию заново?')) {
        try { localStorage.removeItem(REG_KEY); } catch {}
        location.reload();
      }
    });

    // Инициализация при загрузке
    (function init() {
      updateBadge();
      showSection('main');
      showQuizTab('gynecology');
    })();
  </script>
</body>
</html>
